<template>
    <div class="szczegolyPage">
        <div class="pageTitle" :class="navColor($route.params.name)">
            <router-link :to="'/'+$route.params.name+'/viewall'" tag="span" class="pageTitle__prev">⇠</router-link>
            <span class="pageTitle__title">{{ place.properties.name }}</span>
        </div>
        <img class="pageImg" :src="loadImage(place.id)">
        <div class="place">
            <span class="place__title">{{ place.properties.name }}</span>
            <span class="place__open" v-if="isOpen==='open'">Teraz: <span class="place__open--color">otwarte do {{formatDate(openingHours[currentDay]).substr(-5)}}</span></span>
            <span class="place__close" v-if="isOpen==='close'">Teraz: <span class="place__close--color">zamknięte</span>, otwarcie {{whenOpen}}</span>
            <div class="place__icons">
                <a class="place__icons--div">
                    <svg class="place__icons--div-img"><use xlink:href="#address"/></svg>
                </a>
                <a class="place__icons--div" :href="'tel:'+place.properties.phone" v-if="place.properties.phone">
                    <svg class="place__icons--div-img"><use xlink:href="#phone"/></svg>
                </a>
                <a class="place__icons--div" :href="'mailto:'+place.properties.email" v-if="place.properties.email">
                    <svg class="place__icons--div-img"><use xlink:href="#email"/></svg>
                </a>
                <a class="place__icons--div" :href="place.properties['wikipedia:pl']" target="_blank" v-if="place.properties['wikipedia:pl']">
                    <svg class="place__icons--div-img"><use xlink:href="#wiki"/></svg>
                </a>
                <a class="place__icons--div" :href="place.properties.website" target="_blank" v-if="place.properties.website">
                    <svg class="place__icons--div-img"><use xlink:href="#www"/></svg>
                </a>
                <a class="place__icons--div" :href="place.properties.facebook" target="_blank" v-if="place.properties.facebook">
                    <svg class="place__icons--div-img"><use xlink:href="#fb"/></svg>
                </a>
            </div>
            <div class="place__desc">{{ place.properties.description }}</div>
            <br>
            <table class="place__hours" v-if="isOpen">
                <tr>
                    <th colspan="2" class="place__title">Godziny otwarcia:</th>
                </tr>
                <template v-for="(i, index) in fullWeek">
                    <tr :class="{'fbold': index===currentDay}" :key="i">
                        <td>{{fullWeek[index]}}:</td><td>{{formatDate(openingHours[index])}}</td>
                    </tr>
                </template>
            </table>
            <br>
            <br>
            <br>
            <a :href="'https://www.openstreetmap.org/'+place.id" target="_blank">Otwórz w OSM</a><br>
            <a :href="'https://www.openstreetmap.org/edit?'+place.id.replace('/','=')" target="_blank">Edytuj w OSM</a>
        </div>

        <svg display="none">
            <symbol viewBox="0 0 24 24" id="address">
                <path d="M12 1c-3.148 0-6 2.553-6 5.702 0 3.148 2.602 6.907 6 12.298 3.398-5.391 6-9.15 6-12.298 0-3.149-2.851-5.702-6-5.702zm0 8c-1.105 0-2-.895-2-2s.895-2 2-2 2 .895 2 2-.895 2-2 2zm8 6h-3.135c-.385.641-.798 1.309-1.232 2h3.131l.5 1h-4.264l-.344.544-.289.456h.558l.858 2h-7.488l.858-2h.479l-.289-.456-.343-.544h-2.042l-1.011-1h2.42c-.435-.691-.848-1.359-1.232-2h-3.135l-4 8h24l-4-8zm-12.794 6h-3.97l1.764-3.528 1.516 1.528h1.549l-.859 2zm8.808-2h3.75l1 2h-3.892l-.858-2z"></path>
            </symbol>

            <symbol viewBox="0 0 24 24" id="phone">
                <path d="M20 22.621l-3.521-6.795c-.008.004-1.974.97-2.064 1.011-2.24 1.086-6.799-7.82-4.609-8.994l2.083-1.026-3.493-6.817-2.106 1.039c-7.202 3.755 4.233 25.982 11.6 22.615.121-.055 2.102-1.029 2.11-1.033z"></path>
            </symbol>

            <symbol viewBox="0 0 24 24" id="email">
                <path d="M0 3v18h24v-18h-24zm6.623 7.929l-4.623 5.712v-9.458l4.623 3.746zm-4.141-5.929h19.035l-9.517 7.713-9.518-7.713zm5.694 7.188l3.824 3.099 3.83-3.104 5.612 6.817h-18.779l5.513-6.812zm9.208-1.264l4.616-3.741v9.348l-4.616-5.607z"></path>
            </symbol>

            <symbol viewBox="0 0 24 24" id="wiki">
                <path d="m 23.858486,4.5519886 c 0,0.085348 -0.02706,0.1623693 -0.0791,0.2331454 -0.05413,0.068699 -0.110328,0.1040831 -0.17486,0.1040831 -0.518334,0.049963 -0.945075,0.2164935 -1.273978,0.5016813 -0.330984,0.283106 -0.670295,0.8264191 -1.022095,1.6257778 L 15.937765,19.11946 c -0.03539,0.11241 -0.133227,0.168615 -0.295596,0.168615 -0.126982,0 -0.22482,-0.05621 -0.295596,-0.168615 L 12.334408,12.820351 8.8705225,19.11946 c -0.07077,0.11241 -0.168615,0.168615 -0.2955958,0.168615 -0.154043,0 -0.2560444,-0.05621 -0.3060041,-0.168615 L 2.9919059,7.0166762 C 2.6630029,6.2651962 2.3153654,5.7406169 1.9489933,5.4429392 1.5847023,5.1452623 1.0746954,4.959994 0.42313477,4.8892171 c -0.056208,0 -0.1103278,-0.029145 -0.1582065,-0.089511 -0.049963,-0.058282 -0.074936,-0.1269812 -0.074936,-0.2040027 0,-0.1977582 0.056208,-0.295596 0.1686147,-0.295596 0.470456,0 0.96172753,0.020818 1.47589873,0.062454 0.4767006,0.043718 0.9263395,0.064528 1.3468349,0.064528 0.4288226,0 0.9346667,-0.020818 1.5175322,-0.064528 0.6099264,-0.041636 1.1511585,-0.062454 1.6216145,-0.062454 0.1124095,0 0.1686147,0.097838 0.1686147,0.295596 0,0.1956763 -0.035391,0.2935141 -0.1040832,0.2935141 -0.470456,0.03539 -0.8409916,0.1561248 -1.1116077,0.3580465 -0.270616,0.2040028 -0.4059244,0.4704552 -0.4059244,0.80144 0,0.1686139 0.056208,0.3788612 0.1686146,0.6307432 L 9.3971825,16.527791 11.872279,11.852378 9.5657985,7.0166762 C 9.1515465,6.1548678 8.8101545,5.5969829 8.5437014,5.3471832 8.2772489,5.0994652 7.8734062,4.9454223 7.3321741,4.8892171 c -0.049963,0 -0.095756,-0.029145 -0.141553,-0.089511 -0.045799,-0.058282 -0.068691,-0.1269812 -0.068691,-0.2040027 0,-0.1977582 0.047881,-0.295596 0.1477976,-0.295596 0.470456,0 0.9013596,0.020818 1.2947941,0.062454 0.3788617,0.043718 0.7827047,0.064528 1.2115267,0.064528 0.4204955,0 0.8659715,-0.020818 1.3364265,-0.064528 0.485028,-0.041636 0.961728,-0.062454 1.432184,-0.062454 0.112409,0 0.168614,0.097838 0.168614,0.295596 0,0.1956763 -0.03331,0.2935141 -0.104083,0.2935141 -0.940911,0.064536 -1.411366,0.3309848 -1.411366,0.80144 0,0.2102482 0.108246,0.5370694 0.32682,0.9783807 l 1.525859,3.0975145 1.517531,-2.8331435 c 0.210248,-0.399679 0.316413,-0.7369076 0.316413,-1.0116872 0,-0.6453153 -0.470456,-0.9887893 -1.411367,-1.0325045 -0.08535,0 -0.126981,-0.097838 -0.126981,-0.2935141 0,-0.070773 0.02082,-0.1373894 0.06245,-0.1998392 0.04372,-0.064528 0.08535,-0.095757 0.126982,-0.095757 0.337229,0 0.75148,0.020818 1.242752,0.062454 0.470456,0.043718 0.857645,0.064528 1.159486,0.064528 0.216492,0 0.537068,-0.018736 0.957564,-0.054127 0.532906,-0.047881 0.980463,-0.072855 1.338509,-0.072855 0.08327,0 0.124899,0.083267 0.124899,0.2518816 0,0.224819 -0.07702,0.3372285 -0.231064,0.3372285 -0.547477,0.056208 -0.988789,0.2081664 -1.321855,0.4538025 -0.333066,0.2456362 -0.749398,0.8035218 -1.246915,1.6736564 l -2.023376,3.7407478 2.739467,5.580936 4.044669,-9.4049508 c 0.139472,-0.343473 0.210248,-0.659887 0.210248,-0.9471559 0,-0.6890297 -0.470455,-1.0533208 -1.411366,-1.097036 -0.08535,0 -0.126982,-0.097838 -0.126982,-0.2935141 0,-0.1977582 0.06245,-0.295596 0.189432,-0.295596 0.343474,0 0.751479,0.020818 1.221935,0.062454 0.435067,0.043718 0.80144,0.064528 1.094954,0.064528 0.310168,0 0.668214,-0.020818 1.074138,-0.064528 0.422577,-0.041636 0.80144,-0.062454 1.138669,-0.062454 0.09784,0 0.147798,0.083267 0.147798,0.2518816 z"></path>
            </symbol>

            <symbol viewBox="0 0 24 24" id="www">
                <path d="M13.144 8.171c-.035-.066.342-.102.409-.102.074.009-.196.452-.409.102zm-2.152-3.072l.108-.031c.064.055-.072.095-.051.136.086.155.021.248.008.332-.014.085-.104.048-.149.093-.053.066.258.075.262.085.011.033-.375.089-.304.171.096.136.824-.195.708-.176.225-.113.029-.125-.097-.19-.043-.215-.079-.547-.213-.68l.088-.102c-.206-.299-.36.362-.36.362zm13.008 6.901c0 6.627-5.373 12-12 12-6.628 0-12-5.373-12-12s5.372-12 12-12c6.627 0 12 5.373 12 12zm-8.31-5.371c-.006-.146-.19-.284-.382-.031-.135.174-.111.439-.184.557-.104.175.567.339.567.174.025-.277.732-.063.87-.025.248.069.643-.226.211-.381-.355-.13-.542-.269-.574-.523 0 0 .188-.176.106-.166-.218.027-.614.786-.614.395zm6.296 5.371c0-1.035-.177-2.08-.357-2.632-.058-.174-.189-.312-.359-.378-.256-.1-1.337.597-1.5.254-.107-.229-.324.146-.572.008-.12-.066-.454-.515-.605-.46-.309.111.474.964.688 1.076.201-.152.852-.465.992-.038.268.804-.737 1.685-1.251 2.149-.768.694-.624-.449-1.147-.852-.275-.211-.272-.66-.55-.815-.124-.07-.693-.725-.688-.813l-.017.166c-.094.071-.294-.268-.315-.321 0 .295.48.765.639 1.001.271.405.416.995.748 1.326.178.178.858.914 1.035.898.193-.017.803-.458.911-.433.644.152-1.516 3.205-1.721 3.583-.169.317.138 1.101.113 1.476-.029.433-.37.573-.693.809-.346.253-.265.745-.556.925-.517.318-.889 1.353-1.623 1.348-.216-.001-1.14.36-1.261.007-.094-.256-.22-.45-.353-.703-.13-.248-.015-.505-.173-.724-.109-.152-.475-.497-.508-.677-.002-.155.117-.626.28-.708.229-.117.044-.458.016-.656-.048-.354-.267-.646-.53-.851-.389-.299-.188-.537-.097-.964 0-.204-.124-.472-.398-.392-.564.164-.393-.44-.804-.413-.296.021-.538.209-.813.292-.346.104-.7-.082-1.042-.125-1.407-.178-1.866-1.786-1.499-2.946.037-.19-.114-.542-.048-.689.158-.352.48-.747.762-1.014.158-.15.361-.112.547-.229.287-.181.291-.553.572-.781.4-.325.946-.318 1.468-.388.278-.037 1.336-.266 1.503-.06 0 .038.191.604-.019.572.433.023 1.05.749 1.461.579.211-.088.134-.736.567-.423.262.188 1.436.272 1.68.069.15-.124.234-.93.052-1.021.116.115-.611.124-.679.098-.12-.044-.232.114-.425.025.116.055-.646-.354-.218-.667-.179.131-.346-.037-.539.107-.133.108.062.18-.128.274-.302.153-.53-.525-.644-.602-.116-.076-1.014-.706-.77-.295l.789.785c-.039.025-.207-.286-.207-.059.053-.135.02.579-.104.347-.055-.089.09-.139.006-.268 0-.085-.228-.168-.272-.226-.125-.155-.457-.497-.637-.579-.05-.023-.764.087-.824.11-.07.098-.13.201-.179.311-.148.055-.287.126-.419.214l-.157.353c-.068.061-.765.291-.769.3.029-.075-.487-.171-.453-.321.038-.165.213-.68.168-.868-.048-.197 1.074.284 1.146-.235.029-.225.046-.487-.313-.525.068.008.695-.246.799-.36.146-.168.481-.442.724-.442.284 0 .223-.413.354-.615.131.053-.07.376.087.507-.01-.103.445.057.489.033.104-.054.684-.022.594-.294-.1-.277.051-.195.181-.253-.022.009.34-.619.402-.413-.043-.212-.421.074-.553.063-.305-.024-.176-.52-.061-.665.089-.115-.243-.256-.247-.036-.006.329-.312.627-.241 1.064.108.659-.735-.159-.809-.114-.28.17-.509-.214-.364-.444.148-.235.505-.224.652-.476.104-.178.225-.385.385-.52.535-.449.683-.09 1.216-.041.521.048.176.124.104.324-.069.19.286.258.409.099.07-.092.229-.323.298-.494.089-.222.901-.197.334-.536-.374-.223-2.004-.672-3.096-.672-.236 0-.401.263-.581.412-.356.295-1.268.874-1.775.698-.519-.179-1.63.66-1.808.666-.065.004.004-.634.358-.681-.153.023 1.247-.707 1.209-.859-.046-.18-2.799.822-2.676 1.023.059.092.299.092-.016.294-.18.109-.372.801-.541.801-.505.221-.537-.435-1.099.409l-.894.36c-1.328 1.411-2.247 3.198-2.58 5.183-.013.079.334.226.379.28.112.134.112.712.167.901.138.478.479.744.74 1.179.154.259.41.914.329 1.186.108-.178 1.07.815 1.246 1.022.414.487.733 1.077.061 1.559-.217.156.33 1.129.048 1.368l-.361.093c-.356.219-.195.756.021.982 1.818 1.901 4.38 3.087 7.22 3.087 5.517 0 9.989-4.472 9.989-9.989zm-11.507-6.357c.125-.055.293-.053.311-.22.015-.148.044-.046.08-.1.035-.053-.067-.138-.11-.146-.064-.014-.108.069-.149.104l-.072.019-.068.087.008.048-.087.106c-.085.084.002.139.087.102z"></path>
            </symbol>

            <symbol viewBox="0 0 24 24" id="fb">
                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z"></path>
            </symbol>
        </svg>
    </div>
</template>

<script>
import { mapGetters, mapState, mapActions } from "vuex";
import opening_hours from 'opening_hours';
export default {
    name: 'szczegoly',
    data() {
            return {
                fullWeek: ["Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota", "Niedziela"],
                shortWeek: ["pon.", "wt.", "śr.", "czw.", "pt.", "so.", "niedz."],
                currentDay: new Date().getDay() === 0 ? 6 : new Date().getDay() - 1
            }
    },
    computed: {
        ...mapGetters(["addUnits", "countDistance", "loadImage", "navColor"]),
        ...mapState(["poi"]),
        placeId() {
            return this.$route.params.id.replace("_", "/")
        },
        place() {
            return this.poi.filter(el => {
                return el.id===this.placeId
            })[0]
        },
        oh() {
            if (this.place.properties.opening_hours) {
                const oh = new opening_hours(this.place.properties.opening_hours, {"address":{"country":"Poland","country_code":"pl"}}, {'locale':'pl'})
                return oh
            } else {
                return false
            }
        },
        isOpen() {
            if (this.oh) {
                return this.oh.getStateString()
            } else {
                return false
            }
        },
        whenOpen() {
            const nextChange = this.oh.getNextChange()
            const difference = Math.ceil((this.oh.getNextChange() - new Date())/(24 * 60 * 60 * 1000))
            const nextDay = nextChange.getDay() === 0 ? 6 : nextChange.getDay() - 1
            if (difference < 7) {
                return `od: ${this.shortWeek[nextDay]} ${this.addZero(nextChange.getHours())}:${this.addZero(nextChange.getMinutes())}`
            } else {
                return `za ${difference} dni`
            }
            
        },
        openingHours() {
            const dayToMs = 24 * 60 * 60 * 1000
            const correct = (new Date().getDay() -1)*(-1)
            const openingTable = []

            for (let i=0; i<7; i++) {
                const from = new Date(Date.now() + (i + correct) * dayToMs)
                from.setHours(0)
                from.setHours(0)
                from.setMinutes(0)
                from.setSeconds(0)
                from.setMilliseconds(0)
                const to = new Date (from.getTime() + dayToMs)
                const intervals = this.oh.getOpenIntervals(from, to)
                openingTable.push(intervals)
            }
            return openingTable
        }
    },
    methods: {
        ...mapActions(["getPoi"]),
        addZero(i) {
            return (i < 10)? '0'+i : i;
        },
        formatDate(date) {
            if (date.length > 0) {
                return `${this.addZero(date[0][0].getHours())}:${this.addZero(date[0][0].getMinutes())}–${this.addZero(date[0][1].getHours())}:${this.addZero(date[0][1].getMinutes())}`
            } else {
                return "Zamknięte"
            }
        },
    },
    created() {
        
    }
}
</script>

<style lang="scss" scoped>
.szczegolyPage {
    display: flex;
    flex-flow: column;
    overflow-y: auto;
}

.pageTitle {
    height: 45px;
    display: flex;
    align-items: center;
    color: white;
    border-top: $border-grey;
    border-radius: 0 0 7px 7px;

    &__prev {
        font: $h0;
        padding-left: 10px;
        padding-bottom: 5px;
    }

     &__title {
        font: $h1;
        padding: 0 10px 0 10px;
        margin: auto;
        text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
    }
}

.pageImg {
    width: 100%;
}

.place {
    display: flex;
    flex-flow: column;
    margin: 5px 10px 5px 10px;

    &__title {
        font: $h2;
    }

    &__open {
        font: $h3;

        &--color {
            color: $green;
        }
    }

    &__close {
        font: $h3;

        &--color {
            color: $red;
        }
    }

    &__icons {
        display: flex;
        flex-flow: row;

        &--div {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            background-color: white;
            border-radius: 100%;
            border: $border-light-grey;
            margin: 5px 10px 5px 0;

            &-img {
                width: 70%;
                height: 70%;
            }
        }
    }

    &__desc {
        font: $h3;
    }

    &__hours {
        font: $h4b;
        text-align: left;
        margin-right: auto;
    }
}
</style>